# Expungement Project CLI

The CLI available through the entrypoint script `main.py` allows for running: 
- [Expungement Classification](#expungement-classification)
- [VA Court Data Ingestion Pipeline](#va-court-data-ingestion-pipeline)

## Getting Started

To interact with the CLI, open up a terminal and navigate to your local copy of the LAJC-expungement repo. 

Assuming it is in your home directory: 

```bash
$ cd ~/LAJC-expungement
```

We recommend you create a Python virtual environment for running the CLI, as it has a lot of Python package dependencies. Create one (in the folder `.venv/`) with:

```bash
$ python -m venv .venv
```

Then activate it:

```bash
$ source .venv/bin/activate
```

Then install the necessary dependencies for the CLI:

```bash
$ pip install -r requirements.txt
```

Then you should be able to run `main.py` and see the help menu: 

```bash
$ python main.py --help
Usage: main.py [OPTIONS] COMMAND [ARGS]...

  CLI for working with expungement classification pipelines

Options:
  --help  Show this message and exit.

Commands:
  build-db  Build all tables for expungement classification data model
  classify  Run expungement classification pipeline
  ingest    Run ingestion pipeline to clean and load Virginia court data...
```

See options for any command by running python main.py COMMAND --help. Try:

```bash
$ python main.py classify --help
```

# Expungement Classification

Run the expungement classification pipeline to determine whether criminal records are eligible for any level of expungement. 

Run the pipeline with default configurations using:

```bash
$ python main.py classify
```

## Configuration Files

Expungement classification is configurable via YAML config files that change rules about expungement eligibility. These rules represent (some of) the laws that govern expungement eligibility in Virginia. 

Configuration files should be placed in `LAJC-expungement/expunge/configs/`. To create a new config file, start by copying the default configuration file at `LAJC-expungement/expunge/configs/default.yaml`. This file contains explanations as to what each of the configuration fields represent. 

You can pass a configuration file to the pipeline using the `--config-path` option: 

```bash
$ python main.py classify --config-path "expunge/configs/my-config-file.yaml"
```

### Run ID

Each classification run will have a Run ID configured at the top of the config YAML file: 

```yaml
run_id: 'default'
```

This Run ID will be used to query the results of the classification. 

See the run's status and configuration options in the `runs` table: 

```sql
SELECT *
FROM runs
WHERE run_id = 'default'
```

See the expungement classification outcomes in the `outcomes` table: 

```sql
SELECT *
FROM outcomes
WHERE run_id = 'default'
```

**Note**: Repeated runs with the *same* Run ID will OVERWRITE previous results. 

### Other CLI options:

`--write-features`: Pass this flag if you would like to see the features generated by the pipeline. Features will be written to the `features` table. 

`--n-partitions`: The number of partitions for Dask to use for the VA court charges data. Currently, the ideal configuration for a full run is `--n-partitions 32`.  

# VA Court Data Ingestion Pipeline

Currently, we do not have a continuous pipeline to load the latest VA court data. 

What we DO have is a script to clean up the raw court data located in the `expunge` table and load it into the `charges` table. In the future, this will hopefully pull from raw data files and allow for easily adding new files and data as we get access to it. 

To run the ingestion pipeline, use the `ingest` command: 

```bash
$ python main.py ingest
```

By default, the ingestion pipeline will **WIPE ALL DATA** from `charges` before loading data again. 

We do not yet have incremental loads set up. Since data in the `runs`, `features`, and `outcomes` tables depends on `charges` records, those tables will also be wiped. The data is fairly easily recreatable though using the `classify` command and configuration files. 

# Other CLI Commands

* `build-db`
    * Used to create the whole data model (as described in our [data model docs site](https://dbdocs.io/isaak-a/expungement)). Useful for recreating the environment anew (in case we ever change/modify infrastructure), or for making a local development imitation of our database. 
